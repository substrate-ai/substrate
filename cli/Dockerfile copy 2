# Container for building the environment
FROM --platform=linux/amd64 condaforge/mambaforge as conda

ARG CONDA_ENV_NAME=substrate-conda-env

# Install the package as normal:
COPY environment.yml .

RUN conda env create -f environment.yml && \
    conda install -c conda-forge conda-pack && \
    conda clean -ya && \
    conda-pack -n ${CONDA_ENV_NAME} -o /tmp/env.tar && \
    mkdir /venv && cd /venv && tar xf /tmp/env.tar && \
    rm /tmp/env.tar && \
    conda remove --name ${CONDA_ENV_NAME} --all && \
    /venv/bin/conda-unpack

# The runtime-stage image; we can use Debian as the
# base image since the Conda env also includes Python
# for us.
FROM --platform=linux/amd64 nvidia/cuda:11.1.1-cudnn8-runtime-ubuntu20.04 as runtime

# Copy /venv from the previous stage:
COPY --from=conda /venv /venv

COPY src /src

# When image is run, run the code with the environment
# activated:
SHELL ["/bin/bash", "-c"]
ENTRYPOINT source /venv/bin/activate && \
           python /src/main.py
